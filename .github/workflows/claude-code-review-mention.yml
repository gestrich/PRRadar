name: Claude Code Review (@mention)

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: string
      request:
        description: 'Review request (e.g., "@code-review", "@code-review nullability")'
        required: false
        default: '@code-review'
        type: string
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

env:
  # JSON schema for structured output from Claude Code (compact single-line format required)
  REVIEW_SCHEMA: '{"type":"object","properties":{"success":{"type":"boolean","description":"Whether the review was completed successfully"},"summary_file":{"type":"string","description":"Path to the markdown summary file that was created"},"error_message":{"type":"string","description":"Error message if the review failed"}},"required":["success","summary_file"],"additionalProperties":false}'

jobs:
  code-review:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@code-review')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@code-review')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@code-review'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      checks: write
      actions: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        env:
          PR_NUMBER: ${{ inputs.pr_number || github.event.issue.number || github.event.pull_request.number }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true
          prompt: |
            You have been mentioned in a pull request comment with @code-review.

            PR URL: https://github.com/${{ github.repository }}/pull/${{ inputs.pr_number || github.event.issue.number || github.event.pull_request.number }}
            PR Number: ${{ inputs.pr_number || github.event.issue.number || github.event.pull_request.number }}

            User's request:
            ${{ inputs.request || github.event.comment.body || github.event.review.body }}

            Instructions:
            1. Read the code-review skill at .claude/skills/code-review/skill.md
            2. Read the GitHub request handling guide at .claude/skills/code-review/github-request.md
            3. Follow the instructions in github-request.md to handle the user's request
            4. **IMPORTANT OUTPUT REQUIREMENTS:**
               - Create a directory: `mkdir -p review-output`
               - Write your complete review summary to `review-output/review-summary.md` using the Write tool
               - The workflow will automatically upload this as an artifact and post it to the GitHub job summary
            5. When complete, post your response as a comment on the PR using `gh pr comment`
            6. Your structured output MUST include:
               - success: true if review completed, false if it failed
               - summary_file: "review-output/review-summary.md"

          claude_args: --allowedTools Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh api:*),Bash(gh run list:*),Bash(gh run download:*),Bash(cat:*),Bash(mkdir:*),Bash(cp:*),Bash(tee:*),Write --json-schema ${{ toJSON(env.REVIEW_SCHEMA) }}

      - name: Parse structured output
        id: parse-output
        if: always() && steps.claude-review.outputs.execution_file != ''
        run: |
          EXEC_FILE="${{ steps.claude-review.outputs.execution_file }}"
          echo "Parsing execution file: $EXEC_FILE"

          # Extract structured_output from the execution file
          # The structured output can be in different locations depending on the format
          SUMMARY_FILE=$(jq -r '
            # Try array format (verbose mode)
            if type == "array" then
              .[-1].result.structured_output.summary_file // empty
            # Try direct object format
            elif .structured_output then
              .structured_output.summary_file
            elif .result.structured_output then
              .result.structured_output.summary_file
            else
              empty
            end
          ' "$EXEC_FILE" 2>/dev/null || echo "")

          SUCCESS=$(jq -r '
            if type == "array" then
              .[-1].result.structured_output.success // false
            elif .structured_output then
              .structured_output.success
            elif .result.structured_output then
              .result.structured_output.success
            else
              false
            end
          ' "$EXEC_FILE" 2>/dev/null || echo "false")

          echo "summary_file=$SUMMARY_FILE" >> $GITHUB_OUTPUT
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "Parsed summary_file: $SUMMARY_FILE"
          echo "Parsed success: $SUCCESS"

      - name: Write review to job summary
        if: always()
        run: |
          SUMMARY_FILE="${{ steps.parse-output.outputs.summary_file }}"
          # Fallback to default path if structured output parsing failed
          if [ -z "$SUMMARY_FILE" ]; then
            SUMMARY_FILE="review-output/review-summary.md"
          fi

          if [ -f "$SUMMARY_FILE" ]; then
            echo "## Code Review Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat "$SUMMARY_FILE" >> $GITHUB_STEP_SUMMARY
          else
            echo "No review summary generated at $SUMMARY_FILE" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload review artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-pr-${{ inputs.pr_number || github.event.issue.number || github.event.pull_request.number }}
          path: review-output/
          if-no-files-found: ignore
          retention-days: 90
